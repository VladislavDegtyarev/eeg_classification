# @package _global_

# EEG Multiclass Classification Experiment Config
# Uses EEG-specific defaults for loaders, transforms, optimizer, scheduler, logging, trainer, callbacks, and logger

defaults:
  - override /datamodule: eeg.yaml
  - override /module: eeg_single.yaml
  - override /trainer: eeg_default.yaml
  - override /callbacks: eeg_default.yaml
  - override /logger: eeg_default.yaml
  - override /paths: default.yaml
  - override /extras: default.yaml
  - override /hydra: default.yaml

# Task name, determines output directory path
task_name: "eye-state_multiclass_classification"

# Tags to help you identify your experiments
tags: ["eeg", "multiclass", "classification", "eegnet"]

# Set False to skip model training
train: true

# Evaluate on test set, using best model weights achieved during training
test: true
save_state_dict: true

# Simply provide checkpoint path to resume training
ckpt_path: null

# Seed for random number generators in pytorch, numpy and python.random
seed: 42
num_classes: 4
class_names: ['close', 'fon', 'own', 'other']

# Name of the run, accessed by loggers (includes date)
name: "eeg-multiclass-classification_${now:%Y-%m-%d}_${now:%H-%M}"

# DataModule configuration
# Uses eeg.yaml defaults for loaders and transforms
datamodule:
  datasets:
    train:
      _target_: src.datamodules.datasets.ClassificationDataset
      data_path: ${paths.data_dir}/classification/processed/crops_500_30_v2_state_train.parquet
      path_column: crop_path
      target_column: target
      read_mode: npy
      include_names: false
      label_type: "torch.LongTensor"

    valid:
      _target_: src.datamodules.datasets.ClassificationDataset
      data_path: ${paths.data_dir}/classification/processed/crops_500_30_v2_state_valid.parquet
      path_column: crop_path
      target_column: target
      read_mode: npy
      include_names: false
      label_type: "torch.LongTensor"

    test:
      _target_: src.datamodules.datasets.ClassificationDataset
      data_path: ${paths.data_dir}/classification/processed/crops_500_30_v2_state_valid.parquet
      path_column: crop_path
      target_column: target
      read_mode: npy
      include_names: false
      label_type: "torch.LongTensor"

# Module configuration
# Uses eeg_single.yaml defaults for optimizer, scheduler, and logging
module:

  network:
    model:
      _target_: src.modules.models.small_eeg_net.SmallEEGNet
      num_channels: 30
      signal_length: 2500
      num_classes: ${num_classes}

    loss:
      _target_: "src.modules.losses.components.focal_loss_with_label_smoothing.FocalLossWithLabelSmoothing"
      gamma: 2.0
      label_smoothing: 0.1
      reduction: "mean"

    metrics:
      main:
        _target_: "src.modules.metrics.components.classification.MeanAveragePrecision"
        task: "multiclass"
        num_classes: ${num_classes}
      valid_best:
        _target_: "torchmetrics.MaxMetric"
      additional:
        # Secondary metrics
        F1:
          _target_: "torchmetrics.F1Score"
          task: "multiclass"
          num_classes: ${num_classes}
          average: "macro"
        BalancedAccuracy:
          _target_: "src.modules.metrics.components.classification.BalancedAccuracy"
          task: "multiclass"
          num_classes: ${num_classes}
        # Diagnostic metrics
        Recall:
          _target_: "torchmetrics.Recall"
          task: "multiclass"
          num_classes: ${num_classes}
          average: "macro"
        ConfusionMatrix:
          _target_: "src.modules.metrics.components.classification.ConfusionMatrixMetric"
          task: "multiclass"
          num_classes: ${num_classes}
          class_names: ${class_names}
          split: "train"  # Will be set correctly for each split in single_module
        NLL:
          _target_: "src.modules.metrics.components.classification.NegativeLogLikelihood"
          task: "multiclass"
          num_classes: ${num_classes}
          split: "train"  # Will be set correctly for each split in single_module
        # Optional metrics
        AUROC:
          _target_: "torchmetrics.AUROC"
          task: "multiclass"
          num_classes: ${num_classes}
          average: "macro"

    output_activation:
      _target_: "torch.softmax"
      dim: 1

# Trainer configuration - only experiment-specific overrides
trainer:
  max_epochs: 50
  accelerator: gpu
  devices: 1

# Callbacks configuration - only experiment-specific overrides
callbacks:
  model_checkpoint:
    filename: ${replace:"epoch{epoch:03d}-loss_valid{__loss__/valid:.4f}-metric_valid{__metric__/valid_epoch:.4f}"}
    monitor: ${replace:"__metric__/valid_epoch"}

  early_stopping:
    monitor: ${replace:"__metric__/valid_epoch"}
